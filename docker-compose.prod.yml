services:
  traefik:
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      - --api.dashboard=${TRAEFIK_DASHBOARD_ENABLED:-false}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${DOCKER_SOCKET_PATH:-/var/run/docker.sock}:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt

  backend:
    environment:
      STREAMLIT_APP_URL: ${STREAMLIT_APP_URL:-https://ai.example.com/app}
    labels:
      traefik.http.routers.backend-api.entrypoints: websecure
      traefik.http.routers.backend-api.tls: "true"
      traefik.http.routers.backend-api.tls.certresolver: letsencrypt
      traefik.http.routers.backend-landing.entrypoints: websecure
      traefik.http.routers.backend-landing.tls: "true"
      traefik.http.routers.backend-landing.tls.certresolver: letsencrypt

  frontend:
    labels:
      traefik.http.routers.frontend.entrypoints: websecure
      traefik.http.routers.frontend.tls: "true"
      traefik.http.routers.frontend.tls.certresolver: letsencrypt

volumes:
  traefik_letsencrypt:
