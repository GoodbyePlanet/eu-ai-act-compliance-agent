services:
  traefik:
    image: ${TRAEFIK_IMAGE:-traefik:v2.11}
    container_name: compliance-proxy
    user: "${TRAEFIK_UID_GID:-0:0}"
    restart: unless-stopped
    command:
      - --providers.docker=true
      - --providers.docker.endpoint=unix:///var/run/docker.sock
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --api.dashboard=${TRAEFIK_DASHBOARD_ENABLED:-false}
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
    volumes:
      - ${DOCKER_SOCKET_PATH:-/var/run/docker.sock}:/var/run/docker.sock:ro
    networks:
      - ai_act_network

  db:
    image: postgres:15-alpine
    container_name: agent-memory-db
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-agent_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-agent_password}
      POSTGRES_DB: ${POSTGRES_DB:-agent_sessions}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-agent_user} -d ${POSTGRES_DB:-agent_sessions}"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ai_act_network

  backend:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.api
    container_name: compliance-api
    restart: unless-stopped
    env_file:
      - ${APP_ENV_FILE:-.env}
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-agent_user}:${POSTGRES_PASSWORD:-agent_password}@db:5432/${POSTGRES_DB:-agent_sessions}
      STREAMLIT_APP_URL: http://localhost/app
    expose:
      - "8000"
    depends_on:
      db:
        condition: service_healthy
    labels:
      traefik.enable: "true"
      traefik.http.routers.backend-api.rule: ${TRAEFIK_BACKEND_RULE:-PathPrefix(`/api`)}
      traefik.http.routers.backend-api.entrypoints: web
      traefik.http.routers.backend-api.priority: "100"
      traefik.http.routers.backend-api.middlewares: backend-strip-api
      traefik.http.routers.backend-api.service: backend
      traefik.http.routers.backend-landing.rule: ${TRAEFIK_LANDING_RULE:-Path(`/`) || Path(`/about-eu-ai-act`) || Path(`/favicon.ico`) || PathPrefix(`/static`)}
      traefik.http.routers.backend-landing.entrypoints: web
      traefik.http.routers.backend-landing.priority: "200"
      traefik.http.routers.backend-landing.service: backend
      traefik.http.middlewares.backend-strip-api.stripprefix.prefixes: /api
      traefik.http.services.backend.loadbalancer.server.port: "8000"
    networks:
      - ai_act_network

  frontend:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.ui
    container_name: assessment-ui
    restart: unless-stopped
    env_file:
      - ${APP_ENV_FILE:-.env}
    environment:
      API_URL: http://traefik/api
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-agent_user}:${POSTGRES_PASSWORD:-agent_password}@db:5432/${POSTGRES_DB:-agent_sessions}
      STREAMLIT_SERVER_BASE_URL_PATH: /app
    expose:
      - "8501"
    depends_on:
      - backend
    labels:
      traefik.enable: "true"
      traefik.http.routers.frontend.rule: ${TRAEFIK_FRONTEND_RULE:-PathPrefix(`/app`)}
      traefik.http.routers.frontend.entrypoints: web
      traefik.http.routers.frontend.priority: "50"
      traefik.http.services.frontend.loadbalancer.server.port: "8501"
    networks:
      - ai_act_network

networks:
  ai_act_network:
    driver: bridge

volumes:
  postgres_data:
